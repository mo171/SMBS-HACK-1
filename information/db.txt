-- Simple starter SQL for your tables
CREATE TABLE customers (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  full_name text NOT NULL,
  phone_number text UNIQUE,
  total_debt numeric DEFAULT 0
);

CREATE TABLE products (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  name text NOT NULL,
  current_stock int DEFAULT 0,
  base_price numeric
);

CREATE TABLE invoices (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  customer_id uuid REFERENCES customers(id),
  status text DEFAULT 'pending',
  total_amount numeric
);


CREATE OR REPLACE FUNCTION update_stock_level()
RETURNS TRIGGER AS $$
BEGIN
  -- Subtract the sold quantity from the products table
  UPDATE products
  SET current_stock = current_stock - NEW.quantity
  WHERE id = NEW.product_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER decrease_inventory_after_sale
AFTER INSERT ON invoice_items
FOR EACH ROW
EXECUTE FUNCTION update_stock_level();


CREATE TABLE payments (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  customer_id uuid REFERENCES customers(id),
  amount_received numeric NOT NULL,
  payment_mode text, -- e.g., 'Cash', 'UPI', 'GPay'
  created_at timestamp DEFAULT now()
);



create table if not exists public.invoice_items (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at timestamp with time zone default now(),
  invoice_id uuid references public.invoices(id),
  description text,
  quantity numeric,
  unit_price numeric
);


ALTER TABLE products 
ADD CONSTRAINT stock_not_negative CHECK (current_stock >= 0);

CREATE TABLE chat_history (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    role text NOT NULL CHECK (role IN ('user', 'assistant')), -- Distinguishes owner vs AI
    content text NOT NULL,                                    -- The actual message
    metadata jsonb DEFAULT '{}'::jsonb,                       -- Stores intent_type or invoice_id
    created_at timestamptz DEFAULT now()
);

-- Enable Realtime so the chat updates instantly across devices
ALTER PUBLICATION supabase_realtime ADD TABLE chat_history;






-- 1. Create the Profiles Table
CREATE TABLE profiles (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    business_name text NOT NULL,
    owner_name text NOT NULL,
    gst_number text,
    industry text,
    preferred_language text DEFAULT 'English',
    whatsapp_number text,
    created_at timestamptz DEFAULT now()
);

-- 2. Connect existing tables to the Profile
-- This ensures all data belongs to the business set up in Step 1 & 2
ALTER TABLE customers ADD COLUMN profile_id uuid REFERENCES profiles(id);
ALTER TABLE products ADD COLUMN profile_id uuid REFERENCES profiles(id);
ALTER TABLE invoices ADD COLUMN profile_id uuid REFERENCES profiles(id);
ALTER TABLE payments ADD COLUMN profile_id uuid REFERENCES profiles(id);
ALTER TABLE chat_history ADD COLUMN profile_id uuid REFERENCES profiles(id);

-- 3. Enable Realtime for the profile (for that WhatsApp-style sync)
ALTER PUBLICATION supabase_realtime ADD TABLE profiles;


CREATE OR REPLACE FUNCTION update_stock_level()
RETURNS TRIGGER AS $$
BEGIN
  -- Subtract the sold quantity from the products table
  UPDATE products
  SET current_stock = current_stock - NEW.quantity
  WHERE id = NEW.product_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER decrease_inventory_after_sale
AFTER INSERT ON invoice_items
FOR EACH ROW
EXECUTE FUNCTION update_stock_level();

-- 1. WORKFLOW BLUEPRINTS
-- Stores the actual "design" created by the AI or User
CREATE TABLE workflow_blueprints (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users(id), -- For multi-tenancy later
    name TEXT NOT NULL,
    description TEXT,
    nodes JSONB NOT NULL, -- Stores the React Flow nodes
    edges JSONB NOT NULL, -- Stores the React Flow connections
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. WORKFLOW RUN LOGS
-- Stores every single execution history for "Live Status"
CREATE TABLE workflow_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    workflow_id UUID REFERENCES workflow_blueprints(id) ON DELETE CASCADE,
    run_id TEXT NOT NULL, -- The Inngest Run ID
    status TEXT DEFAULT 'running', -- 'running', 'completed', 'failed'
    trigger_data JSONB, -- What started the workflow
    step_results JSONB DEFAULT '{}', -- Details of what each node did
    error_message TEXT,
    started_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);

-- Indexing for speed
CREATE INDEX idx_blueprints_user ON workflow_blueprints(user_id);
CREATE INDEX idx_logs_workflow ON workflow_logs(workflow_id);


-- 1. DROP the broken trigger and function
DROP TRIGGER IF EXISTS decrease_inventory_after_sale ON invoice_items;
DROP FUNCTION IF EXISTS update_stock_level();

-- 2. Add product_id column to invoice_items table
ALTER TABLE invoice_items ADD COLUMN product_id uuid REFERENCES products(id);

-- 3. Create a new working trigger function
CREATE OR REPLACE FUNCTION update_stock_level()
RETURNS TRIGGER AS $$
BEGIN
  -- Only update stock if product_id is provided
  IF NEW.product_id IS NOT NULL THEN
    UPDATE products
    SET current_stock = current_stock - NEW.quantity
    WHERE id = NEW.product_id;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 4. Recreate the trigger
CREATE TRIGGER decrease_inventory_after_sale
  AFTER INSERT ON invoice_items
  FOR EACH ROW
  EXECUTE FUNCTION update_stock_level();

-- 5. Add missing timestamps
ALTER TABLE invoices ADD COLUMN IF NOT EXISTS created_at timestamptz DEFAULT now();
ALTER TABLE customers ADD COLUMN IF NOT EXISTS created_at timestamptz DEFAULT now();
ALTER TABLE products ADD COLUMN IF NOT EXISTS created_at timestamptz DEFAULT now();

-- 6. Enable realtime for workflow tables
ALTER PUBLICATION supabase_realtime ADD TABLE workflow_blueprints;
ALTER PUBLICATION supabase_realtime ADD TABLE workflow_logs;

-- 7. Add performance indexes
CREATE INDEX IF NOT EXISTS idx_invoice_items_product ON invoice_items(product_id);
CREATE INDEX IF NOT EXISTS idx_invoice_items_invoice ON invoice_items(invoice_id);
CREATE INDEX IF NOT EXISTS idx_invoices_customer ON invoices(customer_id);
CREATE INDEX IF NOT EXISTS idx_payments_customer ON payments(customer_id);